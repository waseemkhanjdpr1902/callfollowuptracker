<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Branch Follow-up Pro</title>
    <!-- SheetJS for Excel support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Font Awesome 6 for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ----------------------------------------------
           DARK MODE STYLES (YOUR EXISTING STYLES - UNCHANGED)
        ------------------------------------------------ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Theme variables */
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1a2538;
            --text-primary: #e5e9f0;
            --text-secondary: #94a3b8;
            --accent-primary: #667eea;
            --accent-secondary: #c084fc;
            --border-color: #334155;
            --success-bg: #0f3b2a;
            --success-text: #8cffc3;
            --warning-bg: #5b3c1a;
            --warning-text: #ffe08c;
            --danger-bg: #3f1e2e;
            --danger-text: #fca5a5;
        }

        /* Light theme variables */
        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent-primary: #4f46e5;
            --accent-secondary: #9333ea;
            --border-color: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef9c3;
            --warning-text: #854d0e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 24px;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* top bar with theme toggle */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            gap: 16px;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .title-section h1 {
            font-size: 2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 40px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .theme-toggle i {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .title-section .badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
            margin-top: 6px;
            border: 1px solid var(--border-color);
        }

        .online-status {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-radius: 60px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 8px #4ade80;
        }

        .offline-dot {
            width: 10px;
            height: 10px;
            background: #64748b;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 40px;
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 1px solid var(--border-color);
        }

        .team-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            background: var(--bg-secondary);
            padding: 20px 24px;
            border-radius: 48px;
            margin-bottom: 36px;
            border: 1px solid var(--border-color);
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 6px 16px 6px 10px;
            border-radius: 40px;
            border: 1px solid var(--border-color);
        }

        .member-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .member-role {
            font-size: 0.7rem;
            background: #2d3b52;
            padding: 2px 8px;
            border-radius: 30px;
            color: #b9c7dd;
        }

        /* ----- DASHBOARD CHARTS SECTION ----- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-header h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        /* Quick actions bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 60px;
            border: 1px solid var(--border-color);
        }

        .quick-action-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .quick-action-btn i {
            font-size: 1rem;
        }

        /* Search bar with voice */
        .smart-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .smart-search input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 40px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .smart-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .voice-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .voice-search.listening {
            color: #dc2626;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Keyboard shortcuts hint */
        .shortcuts-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 40px;
            padding: 8px 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            z-index: 100;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .shortcuts-hint:hover {
            background: var(--bg-tertiary);
        }

        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 30px;
            z-index: 1000;
            max-width: 500px;
            width: 90%;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px 18px;
            border-radius: 28px;
            box-shadow: 0 10px 25px -8px rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-card .value {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card .trend {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #4ade80;
        }

        /* ----- NAVIGATION TABS ----- */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 60px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 30px;
            border: none;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-tab.admin-only {
            background: var(--danger-bg);
            color: var(--danger-text);
            display: none; /* Hidden by default, shown only for admins */
        }

        .nav-tab.admin-only.active {
            background: #b91c1c;
            color: white;
        }

        /* ----- SECTIONS ----- */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* ----- UPLOAD/DOWNLOAD BUTTONS ----- */
        .action-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0 20px;
            justify-content: flex-end;
        }

        .file-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .file-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .file-btn.upload {
            background: #1e3a3a;
            border-color: #2a7a5c;
        }

        .file-btn.upload:hover {
            background: #1f4f4f;
        }

        .file-btn.delete-multi {
            background: var(--danger-bg);
            border-color: #b91c1c;
            color: var(--danger-text);
        }

        .file-btn.delete-multi:hover {
            background: #5f2e3e;
        }

        /* table toolbar */
        .table-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 40px 0 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-manager {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .col-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .col-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .col-btn.delete-mode {
            background: var(--danger-bg);
            border-color: #b91c1c;
            color: var(--danger-text);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            margin-bottom: 10px;
            box-shadow: 0 20px 35px -10px black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;       /* columns size to content ‚Äî readable by default */
            font-size: 0.88rem;
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            padding: 14px 14px;
            white-space: nowrap;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            position: relative;
            user-select: none;
        }

        td {
            padding: 11px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;        /* single-line rows */
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        tr:hover td {
            background: var(--bg-tertiary);
        }

        /* Checkbox column */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .actions-cell {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 30px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }

        .icon-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .icon-btn.danger {
            border-color: #aa3e3e;
            color: #fbb5b5;
        }
        .icon-btn.danger:hover {
            background: #632b2b;
            color: white;
        }

        .icon-btn.success {
            border-color: #2e8b57;
            color: #a5f0c5;
        }
        .icon-btn.success:hover {
            background: #1e563a;
        }

        .delete-col-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #991b1b;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        th:hover .delete-col-btn {
            display: flex;
        }

        .add-row-btn {
            margin: 10px 0 30px;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border-color);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 60px;
            font-size: 0.95rem;
            cursor: pointer;
            width: fit-content;
            transition: 0.2s;
        }

        .add-row-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .footer-note {
            text-align: right;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        /* 
         * KEY FIX: td max-width is ignored by browsers with table-layout:auto.
         * We constrain the inner .cell-clamp div instead ‚Äî divs always respect max-width.
         */
        /* table-layout:fixed + inline styles on long-text cells = guaranteed truncation */

        .cell-clamp {
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: 180px;
            width: 180px;
            overflow: hidden;
        }

        .cell-clamp-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .remark-expand-btn {
            flex-shrink: 0;
            background: var(--accent-primary);
            border: none;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 0.72rem;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            white-space: nowrap;
            line-height: 1.6;
            transition: background 0.15s, transform 0.1s;
        }
        .remark-expand-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }

        td.td-date { white-space: nowrap; }

        /* Remark detail modal */
        .remark-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .remark-modal-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            width: 90%;
            max-width: 620px;
            max-height: 85vh;          /* cap height so it never overflows screen */
            display: flex;
            flex-direction: column;    /* header / body / footer stack vertically */
            box-shadow: 0 25px 60px rgba(0,0,0,0.8);
            overflow: hidden;          /* clips children to rounded corners */
        }

        /* ‚îÄ‚îÄ Sticky header ‚îÄ‚îÄ */
        .remark-modal-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 22px 28px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .remark-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ‚îÄ X close button in header ‚îÄ */
        .remark-modal-close {
            flex-shrink: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.15s;
            line-height: 1;
        }
        .remark-modal-close:hover {
            background: #b91c1c;
            border-color: #b91c1c;
            color: white;
        }

        /* ‚îÄ‚îÄ Scrollable body ‚îÄ‚îÄ */
        .remark-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 28px;
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        .remark-modal-body::-webkit-scrollbar { width: 6px; }
        .remark-modal-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }

        .remark-detail-block {
            margin-bottom: 16px;
        }

        .remark-detail-block .label {
            font-size: 0.72rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .remark-detail-block .value {
            font-size: 0.93rem;
            color: var(--text-primary);
            line-height: 1.65;
            word-break: break-word;
            white-space: pre-wrap;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px 14px;
        }

        /* ‚îÄ‚îÄ Sticky footer with action buttons ‚îÄ‚îÄ */
        .remark-modal-footer {
            flex-shrink: 0;
            display: flex;
            gap: 10px;
            padding: 16px 28px 22px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .remark-modal-copy-btn {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 0.88rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }
        .remark-modal-copy-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        /* ‚îÄ‚îÄ Big "Close" button in footer ‚îÄ‚îÄ */
        .remark-modal-close-btn {
            flex: 1;
            background: #1e3a3a;
            border: 1px solid #2a7a5c;
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 0.88rem;
            font-weight: 600;
            color: #a5f0c5;
            cursor: pointer;
            transition: 0.2s;
        }
        .remark-modal-close-btn:hover {
            background: #2e8b57;
            border-color: #2e8b57;
            color: white;
        }

        /* Column sort indicator */
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: var(--bg-tertiary); }
        th.sortable .sort-icon { opacity: 0.4; font-size: 0.75rem; margin-left: 4px; }
        th.sortable.sorted-asc .sort-icon::after { content: ' ‚ñ≤'; opacity: 1; }
        th.sortable.sorted-desc .sort-icon::after { content: ' ‚ñº'; opacity: 1; }
        th.sortable:not(.sorted-asc):not(.sorted-desc) .sort-icon::after { content: ' ‚áÖ'; }

        /* Copy email quick btn */
        .copy-email-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 1px 4px;
            border-radius: 4px;
            transition: 0.15s;
        }
        .copy-email-btn:hover { color: var(--accent-primary); }

        .status-badge {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 500;
            width: fit-content;
        }

        .resolved {
            background: var(--success-bg);
            color: var(--success-text);
        }

        .pending {
            background: var(--warning-bg);
            color: var(--warning-text);
        }

        /* Highlight for aged issues */
        .critical-age {
            background: rgba(185, 28, 28, 0.2) !important;
            border-left: 3px solid #b91c1c;
        }

        .warning-age {
            background: rgba(245, 158, 11, 0.1) !important;
            border-left: 3px solid #f59e0b;
        }

        /* ---------- MODAL STYLES ---------- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px -12px black;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.8rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            padding: 0 10px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .modal-form .full-width {
            grid-column: span 2;
        }

        .form-field {
            margin-bottom: 5px;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .modal-btn.save {
            background: #2e8b57;
            color: white;
        }

        .modal-btn.save:hover {
            background: #3ca36b;
        }

        .modal-btn.cancel {
            background: #4a5568;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #5f6b80;
        }

        .select-all-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        /* ---------- USER MANAGEMENT STYLES ---------- */
        .user-management-container {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .user-stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
        }

        .user-stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .user-stat-card .label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .user-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .user-table th {
            background: var(--bg-tertiary);
            padding: 15px;
            text-align: left;
        }

        .user-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .role-badge {
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
        }

        .role-badge.admin {
            background: var(--danger-bg);
            color: var(--danger-text);
        }

        .role-badge.user {
            background: var(--success-bg);
            color: var(--success-text);
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .admin-warning {
            background: var(--danger-bg);
            color: var(--danger-text);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #b91c1c;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 40px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- ========== TOP BAR ========= -->
    <div class="top-bar">
        <div class="title-section">
            <h1>üöÄ Branch Follow-up Pro</h1>
            <div class="badge">‚ö° Auto-Aging ¬∑ Analytics ¬∑ Smart Search</div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
                <span>Theme</span>
            </div>
        </div>
        <div class="online-status" id="onlineStatusBox">
            <!-- filled by js -->
        </div>
    </div>

    <!-- ========== KEYBOARD SHORTCUTS HINT ========= -->
    <div class="shortcuts-hint" onclick="showShortcuts()">
        <i class="fas fa-keyboard"></i> Shortcuts (Ctrl+?)
    </div>

    <!-- ========== SHORTCUTS MODAL ========= -->
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeShortcuts()">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+N</span> New email row</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+Shift+N</span> New call row</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+F</span> Focus search</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+A</span> Select all rows</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+D</span> Delete selected</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+E</span> Export Excel</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+U</span> Upload file</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+T</span> Theme toggle</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+1</span> Email section</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+2</span> Call section</div>
                <div class="shortcut-item"><span class="shortcut-key">Ctrl+3</span> User management (Admin)</div>
                <div class="shortcut-item"><span class="shortcut-key">Esc</span> Close modal</div>
                <div class="shortcut-item"><span class="shortcut-key">?</span> Show this help</div>
            </div>
        </div>
    </div>

    <!-- ========== NAVIGATION TABS ========= -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('tracker')">üìä Follow-up Tracker</button>
        <button class="nav-tab admin-only" id="adminTabBtn" onclick="switchTab('admin')">üë• User Management (Admin)</button>
    </div>

    <!-- ========== TRACKER SECTION ========= -->
    <div id="tracker-section" class="section active">
        <!-- team members row (dynamic) -->
        <div class="team-grid" id="teamContainer"></div>

        <!-- ========== DASHBOARD CHARTS ========= -->
        <div class="dashboard-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Issue Distribution</h3>
                    <span>Pending vs Resolved</span>
                </div>
                <div class="chart-container">
                    <canvas id="issuePieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i> Aging Trend (7 days)</h3>
                    <span>Avg resolution time</span>
                </div>
                <div class="chart-container">
                    <canvas id="agingLineChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-fire"></i> Team Performance</h3>
                </div>
                <div class="chart-container">
                    <canvas id="teamBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ========== QUICK ACTIONS BAR ========= -->
        <div class="quick-actions">
            <div class="smart-search">
                <i class="fas fa-search"></i>
                <input type="text" id="globalSearch" placeholder="Smart search across all fields...">
                <button class="voice-search" id="voiceSearchBtn" onclick="startVoiceSearch()">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            <button class="quick-action-btn" onclick="quickReminder()">
                <i class="fas fa-bell"></i> Smart Reminder
            </button>
        </div>

        <!-- stats cards -->
        <div class="stats-grid">
            <div class="stat-card" onclick="filterByStatus('email', 'pending')">
                <span class="label"><i class="fas fa-envelope"></i> üìß Total Email Issues</span>
                <span class="value" id="statEmail">0</span>
                <div class="trend"><i class="fas fa-arrow-up"></i> +12% this week</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('call', 'pending')">
                <span class="label"><i class="fas fa-phone"></i> üìû Total Call Issues</span>
                <span class="value" id="statCall">0</span>
                <div class="trend"><i class="fas fa-arrow-down"></i> -5% this week</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('all', 'pending')">
                <span class="label"><i class="fas fa-hourglass-half"></i> ‚è≥ Pending</span>
                <span class="value" id="statPending">0</span>
                <div class="trend">Needs attention</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('all', 'resolved')">
                <span class="label"><i class="fas fa-check-circle"></i> ‚úÖ Resolved</span>
                <span class="value" id="statResolved">0</span>
                <div class="trend">Great job!</div>
            </div>
            <div class="stat-card">
                <span class="label"><i class="fas fa-chart-bar"></i> üìä Avg Days</span>
                <span class="value" id="statAvg">0</span>
                <div class="trend">Target: 5 days</div>
            </div>
            <div class="stat-card" onclick="filterByAge(5)">
                <span class="label"><i class="fas fa-exclamation-triangle"></i> ‚ö†Ô∏è Critical (5+ d)</span>
                <span class="value" id="statCritical">0</span>
                <div class="trend">Urgent attention</div>
            </div>
        </div>

        <!-- Upload/Download Buttons -->
        <div class="action-bar">
            <button class="file-btn upload" id="uploadBtn"><i class="fas fa-cloud-upload-alt"></i> Upload Excel/CSV</button>
            <button class="file-btn" id="downloadEmailBtn"><i class="fas fa-file-excel"></i> üìß Download Email Excel</button>
            <button class="file-btn" id="downloadCallBtn"><i class="fas fa-file-excel"></i> üìû Download Call Excel</button>
        </div>

        <!-- Email Section -->
        <div class="table-toolbar">
            <div class="table-title">
                üìß Email Follow-ups
                <button class="file-btn delete-multi" id="deleteEmailMultiBtn" style="margin-left: 15px;"><i class="fas fa-trash"></i> Delete Selected</button>
            </div>
            <div class="column-manager">
                <button class="col-btn" id="addEmailColBtn"><i class="fas fa-plus"></i> Add column</button>
                <button class="col-btn delete-mode" id="toggleDeleteEmailBtn"><i class="fas fa-trash-alt"></i> Delete mode (off)</button>
            </div>
        </div>
        <div class="select-all-bar">
            <input type="checkbox" id="selectAllEmail"> <label for="selectAllEmail">Select All Email Rows</label>
            <span id="emailSelectedCount" style="color: var(--text-secondary); margin-left: 15px;">0 selected</span>
        </div>
        <div class="table-wrapper">
            <table id="emailTable">
                <thead id="emailThead"></thead>
                <tbody id="emailTbody"></tbody>
            </table>
        </div>
        <div class="add-row-btn" id="addEmailRowBtn"><i class="fas fa-plus-circle"></i> Add new email row (opens form)</div>

        <!-- Call Section -->
        <div class="table-toolbar">
            <div class="table-title">
                üìû Call Follow-ups
                <button class="file-btn delete-multi" id="deleteCallMultiBtn" style="margin-left: 15px;"><i class="fas fa-trash"></i> Delete Selected</button>
            </div>
            <div class="column-manager">
                <button class="col-btn" id="addCallColBtn"><i class="fas fa-plus"></i> Add column</button>
                <button class="col-btn delete-mode" id="toggleDeleteCallBtn"><i class="fas fa-trash-alt"></i> Delete mode (off)</button>
            </div>
        </div>
        <div class="select-all-bar">
            <input type="checkbox" id="selectAllCall"> <label for="selectAllCall">Select All Call Rows</label>
            <span id="callSelectedCount" style="color: var(--text-secondary); margin-left: 15px;">0 selected</span>
        </div>
        <div class="table-wrapper">
            <table id="callTable">
                <thead id="callThead"></thead>
                <tbody id="callTbody"></tbody>
            </table>
        </div>
        <div class="add-row-btn" id="addCallRowBtn"><i class="fas fa-plus-circle"></i> Add new call row (opens form)</div>
    </div>

    <!-- ========== ADMIN SECTION (User Management) ========= -->
	// When rendering the page, check the user's role
	const currentUserRole = sessionStorage.getItem('userRole'); // e.g., 'Admin' or 'User'
	if (currentUserRole !== 'Admin') {
    document.getElementById('userManagementSection').style.display = 'none';
    // Or, even better, do not fetch or render the data at all
	}
    <div id="admin-section" class="section">
        <div class="user-management-container">
            <h2 style="margin-bottom: 20px; color: var(--text-primary);">üë• User Management (Admin Only)</h2>
            
            <!-- Admin Warning (visible if non-admin tries to access) -->
            <div id="adminWarning" class="admin-warning" style="display: none;">
                ‚ö†Ô∏è You need administrator privileges to manage users.
            </div>

            <!-- User Stats - Only visible to admins -->
            <div id="adminStatsSection" style="display: none;">
                <div class="user-stats">
                    <div class="user-stat-card">
                        <div class="number" id="totalUsers">0</div>
                        <div class="label">Total Users</div>
                    </div>
                    <div class="user-stat-card">
                        <div class="number" id="adminCount">0</div>
                        <div class="label">Administrators</div>
                    </div>
                    <div class="user-stat-card">
                        <div class="number" id="regularUsers">0</div>
                        <div class="label">Regular Users</div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="user-controls" id="adminControls">
                    <button class="file-btn success" onclick="openAddUserModal()"><i class="fas fa-user-plus"></i> Add New User</button>
                    <button class="file-btn" onclick="exportUsers()"><i class="fas fa-download"></i> Export Users</button>
                    <button class="file-btn upload" onclick="importUsers()"><i class="fas fa-upload"></i> Import Users</button>
                </div>
            </div>

            <!-- Users Table - Shows ALL users to admin, ONLY current user to regular users -->
            <div class="table-wrapper">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- hidden file input for Excel/CSV upload -->
    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
    <input type="file" id="userFileInput" accept=".csv,.xlsx,.xls" style="display: none;">

    <!-- ========== MODAL FOR EDITING ========= -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Email Follow-up</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-form" id="modalForm">
                <!-- Form fields will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- ========== MODAL FOR ADDING NEW ROW ========= -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addModalTitle">Add New Email Follow-up</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-form" id="addModalForm">
                <!-- Form fields will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- ========== MODAL FOR ADDING/EDITING USERS ========= -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-form" id="userModalForm">
                <div class="form-field full-width">
                    <label>Full Name</label>
                    <input type="text" id="userName" placeholder="Enter full name">
                </div>
                <div class="form-field full-width">
                    <label>Email Address</label>
                    <input type="email" id="userEmail" placeholder="Enter email">
                </div>
                <div class="form-field">
                    <label>Role</label>
                    <select id="userRole">
                        <option value="user">Regular User</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>Initial Status</label>
                    <select id="userStatus">
                        <option value="online">Online</option>
                        <option value="offline" selected>Offline</option>
                    </select>
                </div>
                <div class="form-field full-width">
                    <label>Initials (for avatar)</label>
                    <input type="text" id="userInitials" placeholder="e.g., JD" maxlength="2">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn save" onclick="saveUser()">Save User</button>
                    <button class="modal-btn cancel" onclick="closeUserModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remark Detail Modal -->
    <div class="remark-modal-overlay" id="remarkDetailModal">
        <div class="remark-modal-box">
            <div class="remark-modal-header">
                <h3 id="remarkModalTitle">üìù Full Details</h3>
                <button class="remark-modal-close" onclick="closeRemarkModal()" title="Close">‚úï</button>
            </div>
            <div class="remark-modal-body" id="remarkModalBody"><!-- dynamically filled --></div>
            <div class="remark-modal-footer">
                <button class="remark-modal-copy-btn" id="remarkCopyBtn" onclick="copyRemarkContent()">üìã Copy to Clipboard</button>
                <button class="remark-modal-close-btn" onclick="closeRemarkModal()">‚úï Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle" style="color: #4ade80;"></i>
        <span id="toastMessage">Action completed</span>
    </div>

    <div class="footer-note">‚ö° Auto-aging ¬∑ Multi-delete ¬∑ Smart Search ¬∑ Admin-only User Management</div>
</div>

<script>
    (function() {
        // ----- CONFIGURATION -----
        const emailHeaders = [
            "Select", "S.No", "Email Received From", "Client code", "REGION", "Description/ Subject",
            "Received by", "Email Date", "Email Fwd By", "Email Sent to", "Follow up email sent",
            "Status", "Ageing (Days)", "Pending action from Client", "Resolution Date",
            "Last follow-up date", "Remarks", "Query Type", "Platform", "Actions"
        ];

        const callHeaders = [
            "Select", "S. No", "Call Received From (Client code)", "REGION", "Description",
            "Call Received by", "Call Received Date", "Sent email to", "Follow up email sent",
            "Resolution Date", "Days", "Resolved/Pending", "Remarks", "Actions"
        ];

        // Initial team members (will be managed through user management)
        let teamMembers = [
            { name: "Kavita (You)", email: "kavitamallick@rathi.com", role: "Admin", initial: "K", status: "online" },
            { name: "RAHUL RAGHAVAN", email: "rahulraghvan@rathi.com", role: "Admin", initial: "RR", status: "offline" },
            { name: "Neelam Agarwal", email: "neelamagarwal@rathi.com", role: "User", initial: "NA", status: "offline" },
            { name: "Mohit Mehta", email: "mohitmehta1@rathi.com", role: "User", initial: "MM", status: "offline" },
            { name: "Bhawana Kella", email: "BhawanaKella@rathi.com", role: "User", initial: "BK", status: "offline" },
            { name: "Puran Tak", email: "purantak@rathi.com", role: "User", initial: "PT", status: "offline" },
            { name: "sandeep gahlot", email: "sandeepgahlot@rathi.com", role: "User", initial: "SG", status: "offline" },
            { name: "Harshita Kachhawaha", email: "harshitakachhawaha@rathi.com", role: "User", initial: "HK", status: "offline" },
            { name: "Gajendra Singh", email: "gajendrasingh@rathi.com", role: "User", initial: "GS", status: "offline" }
        ];

        const currentUserName = "Kavita (You)";
        let currentUserIsAdmin = true;

        // Voice recognition
        let recognition = null;

        // Charts
        let pieChart = null;
        let lineChart = null;
        let barChart = null;

        // ----- STATE -----
        let emailDeleteMode = false;
        let callDeleteMode = false;
        let currentEditRow = null;
        let currentEditTable = null;
        let currentAddTable = null;
        let currentEditUser = null;

        // ========== THEME TOGGLE ==========
        window.toggleTheme = function() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            showToast(`Switched to ${newTheme} mode`);
        };

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);

        // ========== TOAST NOTIFICATION ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', function(e) {
            // Ctrl+? for shortcuts
            if (e.ctrlKey && e.key === '?') {
                e.preventDefault();
                showShortcuts();
            }
            // Ctrl+N for new email
            if (e.ctrlKey && e.key === 'n' && !e.shiftKey) {
                e.preventDefault();
                openAddModal('email');
            }
            // Ctrl+Shift+N for new call
            if (e.ctrlKey && e.shiftKey && e.key === 'N') {
                e.preventDefault();
                openAddModal('call');
            }
            // Ctrl+F for search focus
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            // Ctrl+A for select all
            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                const activeTab = document.querySelector('.nav-tab.active').textContent;
                if (activeTab.includes('Tracker')) {
                    if (document.querySelector('#emailTable').offsetParent !== null) {
                        selectAllEmailRows();
                    } else {
                        selectAllCallRows();
                    }
                }
            }
            // Ctrl+D for delete selected
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                const activeTab = document.querySelector('.nav-tab.active').textContent;
                if (activeTab.includes('Tracker')) {
                    if (document.querySelector('#emailTable').offsetParent !== null) {
                        deleteSelectedRows('email');
                    } else {
                        deleteSelectedRows('call');
                    }
                }
            }
            // Ctrl+E for export Excel
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                if (confirm('Export which table? OK for Email, Cancel for Call')) {
                    downloadExcel('email');
                } else {
                    downloadExcel('call');
                }
            }
            // Ctrl+U for upload
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            // Ctrl+T for theme toggle
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                toggleTheme();
            }
            // Ctrl+1 for email section
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                document.getElementById('emailTable').scrollIntoView({ behavior: 'smooth' });
            }
            // Ctrl+2 for call section
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                document.getElementById('callTable').scrollIntoView({ behavior: 'smooth' });
            }
            // Ctrl+3 for admin section
            if (e.ctrlKey && e.key === '3') {
                e.preventDefault();
                if (currentUserIsAdmin) {
                    switchTab('admin');
                }
            }
            // Esc to close modals
            if (e.key === 'Escape') {
                closeModal();
                closeAddModal();
                closeUserModal();
                closeShortcuts();
            }
        });

        window.showShortcuts = function() {
            document.getElementById('shortcutsModal').style.display = 'flex';
        };

        window.closeShortcuts = function() {
            document.getElementById('shortcutsModal').style.display = 'none';
        };

        // ========== SMART SEARCH ==========
        document.getElementById('globalSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            // Search in email table
            document.querySelectorAll('#emailTbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            // Search in call table
            document.querySelectorAll('#callTbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            updateSelectionCounts();
        });

        // ========== VOICE SEARCH ==========
        window.startVoiceSearch = function() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice search is not supported in your browser. Try Chrome or Edge.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            const voiceBtn = document.getElementById('voiceSearchBtn');
            voiceBtn.classList.add('listening');
            voiceBtn.innerHTML = '<i class="fas fa-microphone-alt"></i>';

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('globalSearch').value = transcript;
                document.getElementById('globalSearch').dispatchEvent(new Event('input'));
                showToast(`Searched for: "${transcript}"`);
            };

            recognition.onerror = function(event) {
                showToast('Voice search failed: ' + event.error, 'error');
            };

            recognition.onend = function() {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };

            recognition.start();
        };

        // ========== SMART REMINDERS ==========
        window.quickReminder = function() {
            if (!('Notification' in window)) {
                alert('This browser does not support desktop notifications');
                return;
            }

            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }

            // Check for critical items
            const criticalItems = document.querySelectorAll('.critical-age').length;
            if (criticalItems > 0 && Notification.permission === 'granted') {
                new Notification('üö® Critical Items Alert', {
                    body: `You have ${criticalItems} critical items needing attention!`,
                    icon: 'https://via.placeholder.com/64/667eea/ffffff?text=Alert'
                });
            }

            showToast(`Reminder set: ${criticalItems} critical items need attention`);
        };

        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ========== FILTER FUNCTIONS ==========
        window.filterByStatus = function(type, status) {
            if (type === 'email' || type === 'all') {
                document.querySelectorAll('#emailTbody tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowStatus = cells[11]?.innerText.toLowerCase() || '';
                    if (status === 'pending') {
                        row.style.display = rowStatus.includes('pending') || rowStatus.includes('progress') ? '' : 'none';
                    } else if (status === 'resolved') {
                        row.style.display = rowStatus.includes('resolved') ? '' : 'none';
                    }
                });
            }
            
            if (type === 'call' || type === 'all') {
                document.querySelectorAll('#callTbody tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowStatus = cells[11]?.innerText.toLowerCase() || '';
                    if (status === 'pending') {
                        row.style.display = rowStatus.includes('pending') || rowStatus.includes('progress') ? '' : 'none';
                    } else if (status === 'resolved') {
                        row.style.display = rowStatus.includes('resolved') ? '' : 'none';
                    }
                });
            }
            
            showToast(`Filtered to show ${status} items`);
        };

        window.filterByAge = function(days) {
            document.querySelectorAll('#emailTbody tr, #callTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                let age = 0;
                if (row.closest('#emailTbody')) {
                    age = parseInt(cells[12]?.innerText) || 0;
                } else {
                    age = parseInt(cells[10]?.innerText) || 0;
                }
                row.style.display = age >= days ? '' : 'none';
            });
            showToast(`Showing items aged ${days}+ days`);
        };

        // ========== CHARTS INITIALIZATION ==========
        function initCharts() {
            // Pie Chart
            const pieCtx = document.getElementById('issuePieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Resolved', 'In Progress'],
                    datasets: [{
                        data: [3, 3, 1],
                        backgroundColor: ['#f59e0b', '#4ade80', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: document.body.getAttribute('data-theme') === 'dark' ? '#e5e9f0' : '#1e293b' }
                        }
                    }
                }
            });

            // Line Chart
            const lineCtx = document.getElementById('agingLineChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Avg Resolution Days',
                        data: [5, 4, 6, 3, 5, 2, 4],
                        borderColor: '#667eea',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: document.body.getAttribute('data-theme') === 'dark' ? '#334155' : '#e2e8f0' },
                            ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#475569' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#475569' }
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('teamBarChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Kavita', 'Rahul', 'Neelam', 'Mohit'],
                    datasets: [{
                        label: 'Resolved',
                        data: [12, 8, 15, 10],
                        backgroundColor: '#4ade80'
                    }, {
                        label: 'Pending',
                        data: [3, 5, 2, 4],
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: document.body.getAttribute('data-theme') === 'dark' ? '#334155' : '#e2e8f0' },
                            ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#475569' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: document.body.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#475569' }
                        }
                    }
                }
            });
        }

        // Update charts with real data
        function updateCharts() {
            if (!pieChart) return;
            
            const emailRows = document.querySelectorAll('#emailTbody tr').length;
            const callRows = document.querySelectorAll('#callTbody tr').length;
            
            let pending = 0, resolved = 0, progress = 0;
            
            document.querySelectorAll('#emailTbody tr, #callTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                let status = '';
                if (row.closest('#emailTbody')) {
                    status = cells[11]?.innerText.toLowerCase() || '';
                } else {
                    status = cells[11]?.innerText.toLowerCase() || '';
                }
                
                if (status.includes('pending')) pending++;
                else if (status.includes('resolved')) resolved++;
                else if (status.includes('progress')) progress++;
            });
            
            pieChart.data.datasets[0].data = [pending, resolved, progress];
            pieChart.update();
            
            // Update line chart with real aging data
            const agingData = [];
            for (let i = 0; i < 7; i++) {
                let totalDays = 0;
                let count = 0;
                document.querySelectorAll('#emailTbody tr, #callTbody tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let age = 0;
                    if (row.closest('#emailTbody')) {
                        age = parseInt(cells[12]?.innerText) || 0;
                    } else {
                        age = parseInt(cells[10]?.innerText) || 0;
                    }
                    if (age > 0) {
                        totalDays += age;
                        count++;
                    }
                });
                agingData.push(count > 0 ? (totalDays / count).toFixed(1) : 0);
            }
            
            lineChart.data.datasets[0].data = agingData;
            lineChart.update();
            
            // Update bar chart with team performance
            const teamStats = {};
            document.querySelectorAll('#emailTbody tr, #callTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                let receivedBy = '';
                if (row.closest('#emailTbody')) {
                    receivedBy = cells[6]?.innerText || '';
                } else {
                    receivedBy = cells[5]?.innerText || '';
                }
                
                if (!teamStats[receivedBy]) {
                    teamStats[receivedBy] = { resolved: 0, pending: 0 };
                }
                
                const status = row.closest('#emailTbody') ? cells[11]?.innerText.toLowerCase() || '' : cells[11]?.innerText.toLowerCase() || '';
                if (status.includes('resolved')) {
                    teamStats[receivedBy].resolved++;
                } else if (status.includes('pending') || status.includes('progress')) {
                    teamStats[receivedBy].pending++;
                }
            });
            
            const teamNames = Object.keys(teamStats).slice(0, 4);
            const resolvedData = teamNames.map(name => teamStats[name]?.resolved || 0);
            const pendingData = teamNames.map(name => teamStats[name]?.pending || 0);
            
            barChart.data.labels = teamNames;
            barChart.data.datasets[0].data = resolvedData;
            barChart.data.datasets[1].data = pendingData;
            barChart.update();
        }

        // ========== TAB SWITCHING ==========
        window.switchTab = function(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'tracker') {
                document.querySelector('.nav-tab').classList.add('active');
                document.getElementById('tracker-section').classList.add('active');
                setTimeout(() => updateCharts(), 100);
            } else {
                if (!currentUserIsAdmin) {
                    showToast('Admin access only');
                    return;
                }
                document.getElementById('adminTabBtn').classList.add('active');
                document.getElementById('admin-section').classList.add('active');
                renderUserTable();
            }
        };

        // ========== USER MANAGEMENT FUNCTIONS ==========
        
        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            // Check if current user is admin
            const currentUser = teamMembers.find(u => u.name === currentUserName);
            currentUserIsAdmin = currentUser && currentUser.role === 'Admin';
            
            // Show/hide admin tab
            document.getElementById('adminTabBtn').style.display = currentUserIsAdmin ? 'block' : 'none';
            
            // Show/hide admin warning and stats
            document.getElementById('adminWarning').style.display = currentUserIsAdmin ? 'none' : 'block';
            document.getElementById('adminStatsSection').style.display = currentUserIsAdmin ? 'block' : 'none';
            
            // Update stats
            if (currentUserIsAdmin) {
                document.getElementById('totalUsers').textContent = teamMembers.length;
                document.getElementById('adminCount').textContent = teamMembers.filter(u => u.role === 'Admin').length;
                document.getElementById('regularUsers').textContent = teamMembers.filter(u => u.role === 'User').length;
            }
            
            // Render users - for non-admins, show only themselves
            const usersToShow = currentUserIsAdmin ? teamMembers : [currentUser];
            
            usersToShow.forEach((user, index) => {
                const tr = document.createElement('tr');
                
                // Select checkbox (only for admins)
                const selectTd = document.createElement('td');
                if (currentUserIsAdmin) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'user-select';
                    checkbox.value = teamMembers.indexOf(user);
                    selectTd.appendChild(checkbox);
                } else {
                    selectTd.textContent = '-';
                }
                tr.appendChild(selectTd);
                
                // Name
                const nameTd = document.createElement('td');
                nameTd.innerHTML = `<span class="user-avatar" style="margin-right: 8px;">${user.initial}</span> ${user.name}`;
                tr.appendChild(nameTd);
                
                // Email
                const emailTd = document.createElement('td');
                emailTd.textContent = user.email;
                tr.appendChild(emailTd);
                
                // Role
                const roleTd = document.createElement('td');
                roleTd.innerHTML = `<span class="role-badge ${user.role === 'Admin' ? 'admin' : 'user'}">${user.role}</span>`;
                tr.appendChild(roleTd);
                
                // Status
                const statusTd = document.createElement('td');
                statusTd.innerHTML = `<span class="${user.status === 'online' ? 'online-dot' : 'offline-dot'}"></span> ${user.status}`;
                tr.appendChild(statusTd);
                
                // Last Active
                const lastActiveTd = document.createElement('td');
                lastActiveTd.textContent = user.status === 'online' ? 'Just now' : '2 hours ago';
                tr.appendChild(lastActiveTd);
                
                // Actions
                const actionsTd = document.createElement('td');
                actionsTd.className = 'user-actions';
                
                if (currentUserIsAdmin) {
                    // Don't allow editing/deleting self if last admin
                    const isSelf = user.name === currentUserName;
                    const isLastAdmin = user.role === 'Admin' && teamMembers.filter(u => u.role === 'Admin').length === 1;
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn';
                    editBtn.title = 'Edit user';
                    editBtn.innerHTML = '‚úèÔ∏è';
                    editBtn.onclick = () => openEditUserModal(teamMembers.indexOf(user));
                    actionsTd.appendChild(editBtn);
                    
                    if (!(isSelf && isLastAdmin)) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'icon-btn danger';
                        delBtn.title = 'Delete user';
                        delBtn.innerHTML = 'üóëÔ∏è';
                        delBtn.onclick = () => deleteUser(teamMembers.indexOf(user));
                        actionsTd.appendChild(delBtn);
                    }
                    
                    // Promote/demote button (if not self)
                    if (!isSelf) {
                        const roleBtn = document.createElement('button');
                        roleBtn.className = 'icon-btn success';
                        roleBtn.title = user.role === 'Admin' ? 'Demote to User' : 'Promote to Admin';
                        roleBtn.innerHTML = user.role === 'Admin' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
                        roleBtn.onclick = () => toggleUserRole(teamMembers.indexOf(user));
                        actionsTd.appendChild(roleBtn);
                    }
                } else {
                    actionsTd.textContent = 'No actions';
                }
                
                tr.appendChild(actionsTd);
                tbody.appendChild(tr);
            });
        }

        window.openAddUserModal = function() {
            if (!currentUserIsAdmin) {
                alert('Only administrators can add users');
                return;
            }
            currentEditUser = null;
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userStatus').value = 'offline';
            document.getElementById('userInitials').value = '';
            document.getElementById('userModal').style.display = 'flex';
        };

        window.openEditUserModal = function(index) {
            if (!currentUserIsAdmin) return;
            
            const user = teamMembers[index];
            currentEditUser = { index, ...user };
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userName').value = user.name.replace(' (You)', '');
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role.toLowerCase();
            document.getElementById('userStatus').value = user.status;
            document.getElementById('userInitials').value = user.initial;
            document.getElementById('userModal').style.display = 'flex';
        };

        window.saveUser = function() {
            if (!currentUserIsAdmin) return;
            
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            let initials = document.getElementById('userInitials').value.trim().toUpperCase();
            
            if (!name || !email) {
                alert('Name and email are required');
                return;
            }
            
            // Generate initials if not provided
            if (!initials) {
                initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }
            
            const formattedName = name + (name === 'Kavita' ? ' (You)' : '');
            
            if (currentEditUser) {
                // Update existing user
                teamMembers[currentEditUser.index] = {
                    name: formattedName,
                    email: email,
                    role: role.charAt(0).toUpperCase() + role.slice(1),
                    initial: initials,
                    status: status
                };
            } else {
                // Add new user
                teamMembers.push({
                    name: formattedName,
                    email: email,
                    role: role.charAt(0).toUpperCase() + role.slice(1),
                    initial: initials,
                    status: status
                });
            }
            
            // Refresh displays
            renderTeamAndOnline();
            renderUserTable();
            closeUserModal();
            showToast('User saved successfully');
        };

        window.deleteUser = function(index) {
            if (!currentUserIsAdmin) return;
            
            const user = teamMembers[index];
            
            // Prevent deleting self
            if (user.name === currentUserName) {
                alert('You cannot delete your own account');
                return;
            }
            
            // Prevent deleting last admin
            if (user.role === 'Admin' && teamMembers.filter(u => u.role === 'Admin').length === 1) {
                alert('Cannot delete the last administrator');
                return;
            }
            
            if (confirm(`Delete user ${user.name}?`)) {
                teamMembers.splice(index, 1);
                renderTeamAndOnline();
                renderUserTable();
                showToast('User deleted');
            }
        };

        window.toggleUserRole = function(index) {
            if (!currentUserIsAdmin) return;
            
            const user = teamMembers[index];
            
            // Prevent demoting self if last admin
            if (user.name === currentUserName && user.role === 'Admin' && teamMembers.filter(u => u.role === 'Admin').length === 1) {
                alert('You cannot demote yourself as the last administrator');
                return;
            }
            
            user.role = user.role === 'Admin' ? 'User' : 'Admin';
            renderTeamAndOnline();
            renderUserTable();
            showToast(`${user.name} is now ${user.role}`);
        };

        window.exportUsers = function() {
            if (!currentUserIsAdmin) return;
            
            const data = [['Name', 'Email', 'Role', 'Initials', 'Status']];
            teamMembers.forEach(user => {
                data.push([user.name.replace(' (You)', ''), user.email, user.role, user.initial, user.status]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Users');
            XLSX.writeFile(wb, 'users.xlsx');
            showToast('Users exported');
        };

        window.importUsers = function() {
            if (!currentUserIsAdmin) return;
            document.getElementById('userFileInput').click();
        };

        function handleUserFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                let data = [];
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'csv') {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    data = lines.map(line => line.split(',').map(s => s.replace(/^"|"$/g, '')));
                } else {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                }
                
                // Skip header row
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row.length >= 3 && row[0] && row[1]) {
                        const name = row[0] + (row[0] === 'Kavita' ? ' (You)' : '');
                        teamMembers.push({
                            name: name,
                            email: row[1],
                            role: row[2] || 'User',
                            initial: row[3] || row[0].split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(),
                            status: row[4] || 'offline'
                        });
                    }
                }
                
                renderTeamAndOnline();
                renderUserTable();
                showToast('Users imported');
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
            
            event.target.value = '';
        }

        window.closeUserModal = function() {
            document.getElementById('userModal').style.display = 'none';
            currentEditUser = null;
        };

        // ========== RENDER TEAM & ONLINE STATUS ==========
        function renderTeamAndOnline() {
            const teamContainer = document.getElementById('teamContainer');
            const onlineBox = document.getElementById('onlineStatusBox');
            teamContainer.innerHTML = '';

            let onlineCount = 0;
            teamMembers.forEach(m => {
                const isYou = (m.name === currentUserName);
                const div = document.createElement('div');
                div.className = 'team-member';
                const dot = m.status === 'online' ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>';
                const roleBadge = m.role ? `<span class="member-role">${m.role}</span>` : '';
                div.innerHTML = `
                    <span class="user-avatar">${m.initial}</span>
                    <span class="member-name">${dot}${m.name}</span>
                    ${roleBadge}
                    <span style="font-size:0.7rem; color:#8195b0;">${m.email}</span>
                `;
                teamContainer.appendChild(div);
                if (m.status === 'online') onlineCount++;
            });
            onlineBox.innerHTML = onlineCount 
                ? `<span class="online-dot"></span> <strong>You (${currentUserName})</strong> and ${onlineCount-1} others online ¬∑ last activity just now`
                : `<span class="offline-dot"></span> Everyone offline`;
        }

        // ========== AGING CALCULATION FUNCTIONS ==========
        
        function parseDateString(dateStr) {
            if (!dateStr || dateStr === '') return null;
            
            if (!isNaN(dateStr) && dateStr.toString().indexOf('-') === -1 && dateStr.toString().indexOf('/') === -1) {
                const excelEpoch = new Date(1899, 11, 31);
                const msPerDay = 86400000;
                return new Date(excelEpoch.getTime() + (parseFloat(dateStr) * msPerDay));
            }
            
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date;
            }

            const parts = dateStr.split(/[\/\-]/);
            if (parts.length === 3) {
                const d = new Date(parts[2], parts[1]-1, parts[0]);
                if (!isNaN(d.getTime())) return d;
            }
            
            return null;
        }

        // Format a date value (string, ISO, or Excel serial) to DD/MM/YYYY
        function formatDateForDisplay(val) {
            if (val === null || val === undefined || val === '') return '';
            const str = val.toString().trim();
            if (str === '') return '';
            // Excel serial number (numeric, > 1000, no separators)
            if (!isNaN(str) && str.indexOf('-') === -1 && str.indexOf('/') === -1 && parseFloat(str) > 1000) {
                const excelEpoch = new Date(1899, 11, 31);
                const d = new Date(excelEpoch.getTime() + parseFloat(str) * 86400000);
                if (!isNaN(d.getTime())) {
                    return d.toLocaleDateString('en-GB'); // DD/MM/YYYY
                }
            }
            const d = parseDateString(str);
            if (d && !isNaN(d.getTime())) {
                return d.toLocaleDateString('en-GB');
            }
            return str;
        }

        // ========== REMARKS MODAL ==========
        let _currentRemarkContent = '';
        
        window.openRemarkModal = function(title, details) {
            _currentRemarkContent = details.map(d => `${d.label}: ${d.value}`).join('\n');
            document.getElementById('remarkModalTitle').textContent = 'üìù ' + title;
            const body = document.getElementById('remarkModalBody');
            body.innerHTML = details.map(d => `
                <div class="remark-detail-block">
                    <div class="label">${d.label}</div>
                    <div class="value">${d.value || '‚Äî'}</div>
                </div>
            `).join('');
            document.getElementById('remarkDetailModal').style.display = 'flex';
        };

        window.closeRemarkModal = function() {
            document.getElementById('remarkDetailModal').style.display = 'none';
        };

        window.copyRemarkContent = function() {
            navigator.clipboard.writeText(_currentRemarkContent).then(() => showToast('Copied to clipboard'));
        };

        // Close remark modal on outside click
        document.getElementById('remarkDetailModal').addEventListener('click', function(e) {
            if (e.target === this) closeRemarkModal();
        });

        // ========== SORTABLE COLUMNS ==========
        function makeSortable(tableId, theadId) {
            const thead = document.getElementById(theadId);
            if (!thead) return;
            const ths = thead.querySelectorAll('th');
            ths.forEach((th, colIdx) => {
                // Skip checkbox and actions columns
                if (colIdx === 0 || colIdx === ths.length - 1) return;
                th.classList.add('sortable');
                const icon = document.createElement('span');
                icon.className = 'sort-icon';
                th.appendChild(icon);
                th.addEventListener('click', function() {
                    const isAsc = th.classList.contains('sorted-asc');
                    ths.forEach(t => t.classList.remove('sorted-asc', 'sorted-desc'));
                    th.classList.toggle('sorted-asc', !isAsc);
                    th.classList.toggle('sorted-desc', isAsc);
                    sortTable(tableId, colIdx, !isAsc);
                });
            });
        }

        function sortTable(tableId, colIdx, asc) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const aText = a.querySelectorAll('td')[colIdx]?.innerText.trim() || '';
                const bText = b.querySelectorAll('td')[colIdx]?.innerText.trim() || '';
                const aNum = parseFloat(aText), bNum = parseFloat(bText);
                if (!isNaN(aNum) && !isNaN(bNum)) return asc ? aNum - bNum : bNum - aNum;
                // Try date
                const aDate = parseDateString(aText), bDate = parseDateString(bText);
                if (aDate && bDate) return asc ? aDate - bDate : bDate - aDate;
                return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        function calculateAging(receivedDateStr, status, resolutionDateStr = null) {
            const receivedDate = parseDateString(receivedDateStr);
            if (!receivedDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (status && (status.toLowerCase().includes('resolved') || status.toLowerCase().includes('completed'))) {
                const resolutionDate = parseDateString(resolutionDateStr);
                if (resolutionDate) {
                    resolutionDate.setHours(0, 0, 0, 0);
                    const diffTime = Math.abs(resolutionDate - receivedDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays.toString();
                }
            }
            
            receivedDate.setHours(0, 0, 0, 0);
            const diffTime = Math.abs(today - receivedDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays.toString();
        }

        function updateAllAging() {
            // Update email aging
            document.querySelectorAll('#emailTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 14) return;
                
                const receivedDate = cells[7]?.innerText;
                const status = cells[11]?.innerText;
                const resolutionDate = cells[14]?.innerText;
                
                const aging = calculateAging(receivedDate, status, resolutionDate);
                const agingCell = cells[12];
                if (agingCell) {
                    agingCell.innerText = aging;
                    
                    const ageNum = parseInt(aging) || 0;
                    row.classList.remove('critical-age', 'warning-age');
                    if (ageNum >= 10) {
                        row.classList.add('critical-age');
                    } else if (ageNum >= 5) {
                        row.classList.add('warning-age');
                    }
                }
            });
            
            // Update call aging
            document.querySelectorAll('#callTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 12) return;
                
                const receivedDate = cells[6]?.innerText;
                const status = cells[11]?.innerText;
                const resolutionDate = cells[9]?.innerText;
                
                const aging = calculateAging(receivedDate, status, resolutionDate);
                const daysCell = cells[10];
                if (daysCell) {
                    daysCell.innerText = aging;
                    
                    const ageNum = parseInt(aging) || 0;
                    row.classList.remove('critical-age', 'warning-age');
                    if (ageNum >= 10) {
                        row.classList.add('critical-age');
                    } else if (ageNum >= 5) {
                        row.classList.add('warning-age');
                    }
                }
            });
            
            updateStats();
            updateCharts();
        }

        // ========== MODAL FUNCTIONS ==========
        
        window.openEditModal = function(button, tableType) {
            const row = button.closest('tr');
            if (!row) return;
            
            currentEditRow = row;
            currentEditTable = tableType;
            
            const headers = tableType === 'email' ? emailHeaders.slice(2, -1) : callHeaders.slice(2, -1);
            document.getElementById('modalTitle').textContent = tableType === 'email' ? 'Edit Email Follow-up' : 'Edit Call Follow-up';
            
            const modalForm = document.getElementById('modalForm');
            modalForm.innerHTML = '';
            
            const cells = row.querySelectorAll('td');
            
            for (let i = 2; i < cells.length - 1; i++) {
                const header = headers[i-2];
                const value = cells[i].innerText;
                
                const fieldDiv = document.createElement('div');
                fieldDiv.className = i > 10 ? 'full-width form-field' : 'form-field';
                
                const label = document.createElement('label');
                label.htmlFor = `edit_field_${i}`;
                label.textContent = header;
                
                let input;
                if (header.includes('Date')) {
                    input = document.createElement('input');
                    input.type = 'date';
                    const parsedDate = parseDateString(value);
                    if (parsedDate) {
                        input.value = parsedDate.toISOString().split('T')[0];
                    }
                } else if (header === 'Status' || header === 'Resolved/Pending' || header === 'Platform' || header === 'Query Type') {
                    input = document.createElement('select');
                    let options = [];
                    if (header === 'Status' || header === 'Resolved/Pending') {
                        options = ['Pending', 'Resolved', 'In Progress', 'On Hold'];
                    } else if (header === 'Platform') {
                        options = ['Email', 'Phone', 'Portal', 'In Person'];
                    } else if (header === 'Query Type') {
                        options = ['Billing', 'Statements', 'Technical', 'General', 'Other'];
                    }
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (value === opt) option.selected = true;
                        input.appendChild(option);
                    });
                } else if (header.includes('Description') || header.includes('Remarks')) {
                    input = document.createElement('textarea');
                    input.value = value;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = value;
                }
                
                input.id = `edit_field_${i}`;
                input.name = `edit_field_${i}`;
                
                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                modalForm.appendChild(fieldDiv);
            }
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'modal-actions';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'modal-btn save';
            saveBtn.textContent = 'Save Changes';
            saveBtn.onclick = saveModalChanges;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn cancel';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeModal;
            
            actionDiv.appendChild(saveBtn);
            actionDiv.appendChild(cancelBtn);
            modalForm.appendChild(actionDiv);
            
            document.getElementById('editModal').style.display = 'flex';
        };

        window.saveModalChanges = function() {
            if (!currentEditRow || !currentEditTable) return;
            
            const cells = currentEditRow.querySelectorAll('td');
            
            for (let i = 2; i < cells.length - 1; i++) {
                const input = document.getElementById(`edit_field_${i}`);
                if (input) {
                    cells[i].innerText = input.value;
                }
            }
            
            updateAllAging();
            closeModal();
            showToast('Changes saved');
        };

        window.openAddModal = function(tableType) {
            currentAddTable = tableType;
            
            const headers = tableType === 'email' ? emailHeaders.slice(2, -1) : callHeaders.slice(2, -1);
            document.getElementById('addModalTitle').textContent = tableType === 'email' ? 'Add New Email Follow-up' : 'Add New Call Follow-up';
            
            const modalForm = document.getElementById('addModalForm');
            modalForm.innerHTML = '';
            
            headers.forEach((header, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = index > 8 ? 'full-width form-field' : 'form-field';
                
                const label = document.createElement('label');
                label.htmlFor = `add_field_${index}`;
                label.textContent = header;
                
                let input;
                if (header.includes('Date')) {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = new Date().toISOString().split('T')[0];
                } else if (header === 'Status' || header === 'Resolved/Pending' || header === 'Platform' || header === 'Query Type') {
                    input = document.createElement('select');
                    let options = [];
                    if (header === 'Status' || header === 'Resolved/Pending') {
                        options = ['Pending', 'Resolved', 'In Progress', 'On Hold'];
                    } else if (header === 'Platform') {
                        options = ['Email', 'Phone', 'Portal', 'In Person'];
                    } else if (header === 'Query Type') {
                        options = ['Billing', 'Statements', 'Technical', 'General', 'Other'];
                    }
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (opt === 'Pending') option.selected = true;
                        input.appendChild(option);
                    });
                } else if (header.includes('Description') || header.includes('Remarks')) {
                    input = document.createElement('textarea');
                    input.value = '';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = '';
                }
                
                input.id = `add_field_${index}`;
                input.name = `add_field_${index}`;
                input.placeholder = `Enter ${header}`;
                
                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                modalForm.appendChild(fieldDiv);
            });
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'modal-actions';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'modal-btn save';
            saveBtn.textContent = 'Add Row';
            saveBtn.onclick = saveNewRow;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn cancel';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeAddModal;
            
            actionDiv.appendChild(saveBtn);
            actionDiv.appendChild(cancelBtn);
            modalForm.appendChild(actionDiv);
            
            document.getElementById('addModal').style.display = 'flex';
        };

        window.saveNewRow = function() {
            if (!currentAddTable) return;
            
            const tableType = currentAddTable;
            const headers = tableType === 'email' ? emailHeaders.slice(2, -1) : callHeaders.slice(2, -1);
            const tbody = tableType === 'email' ? document.getElementById('emailTbody') : document.getElementById('callTbody');
            
            const newRow = document.createElement('tr');
            newRow.id = `${tableType}-row-${Date.now()}`;
            
            // Select checkbox
            const selectTd = document.createElement('td');
            selectTd.className = 'checkbox-cell';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = `${tableType}-row-select`;
            selectTd.appendChild(checkbox);
            newRow.appendChild(selectTd);
            
            // S.No
            const snoTd = document.createElement('td');
            snoTd.textContent = (tbody.children.length + 1).toString();
            newRow.appendChild(snoTd);
            
            // Collect values first, then render with makeSmartCell
            const rowData = headers.map((h, i) => {
                const input = document.getElementById(`add_field_${i}`);
                return input ? input.value : '';
            });

            headers.forEach((header, i) => {
                newRow.appendChild(makeSmartCell(header, rowData[i], headers, rowData));
            });
            
            // Actions
            newRow.appendChild(createActionCell(tableType));
            
            tbody.appendChild(newRow);
            
            updateAllAging();
            renumberRows(tableType);
            updateStats();
            closeAddModal();
            showToast('New row added');
        };

        window.closeModal = function() {
            document.getElementById('editModal').style.display = 'none';
            currentEditRow = null;
            currentEditTable = null;
        };

        window.closeAddModal = function() {
            document.getElementById('addModal').style.display = 'none';
            currentAddTable = null;
        };

        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const addModal = document.getElementById('addModal');
            const userModal = document.getElementById('userModal');
            const shortcutsModal = document.getElementById('shortcutsModal');
            
            if (event.target === editModal) closeModal();
            if (event.target === addModal) closeAddModal();
            if (event.target === userModal) closeUserModal();
            if (event.target === shortcutsModal) closeShortcuts();
        };

        // ========== ROW MANAGEMENT ==========
        
        function createActionCell(tableType) {
            const td = document.createElement('td');
            td.className = 'actions-cell';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'icon-btn';
            editBtn.title = 'Edit row (opens form)';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.onclick = (e) => { 
                e.stopPropagation(); 
                openEditModal(e.target, tableType); 
            };
            
            const delBtn = document.createElement('button');
            delBtn.className = 'icon-btn danger';
            delBtn.title = 'Delete row';
            delBtn.innerHTML = 'üóëÔ∏è';
            delBtn.onclick = (e) => { e.stopPropagation(); deleteSingleRow(e, tableType); };
            
            td.appendChild(editBtn);
            td.appendChild(delBtn);
            return td;
        }

        window.deleteSingleRow = function(event, tableType) {
            const row = event.target.closest('tr');
            if (!row) return;
            if (confirm('Delete this row?')) {
                row.remove();
                renumberRows(tableType);
                updateAllAging();
                updateSelectionCounts();
                showToast('Row deleted');
            }
        };

        window.deleteSelectedRows = function(tableType) {
            const checkboxes = document.querySelectorAll(`.${tableType}-row-select:checked`);
            if (checkboxes.length === 0) {
                alert('No rows selected');
                return;
            }
            
            if (confirm(`Delete ${checkboxes.length} selected row(s)?`)) {
                checkboxes.forEach(cb => {
                    const row = cb.closest('tr');
                    if (row) row.remove();
                });
                renumberRows(tableType);
                updateAllAging();
                updateSelectionCounts();
                
                if (tableType === 'email') {
                    document.getElementById('selectAllEmail').checked = false;
                } else {
                    document.getElementById('selectAllCall').checked = false;
                }
                
                showToast(`${checkboxes.length} rows deleted`);
            }
        };

        function renumberRows(tableType) {
            const tbody = tableType === 'email' ? document.getElementById('emailTbody') : document.getElementById('callTbody');
            Array.from(tbody.children).forEach((tr, idx) => {
                const snoTd = tr.querySelector('td:nth-child(2)');
                if (snoTd) snoTd.textContent = (idx + 1).toString();
            });
        }

        function filterEmptyRows(data) {
            return data.filter(row => {
                return row.some(cell => cell && cell.toString().trim() !== '');
            });
        }

        // ========== SMART CELL RENDERER (header-name based) ==========

        // Returns true if the header name is a date column
        function isDateHeader(h) {
            const lower = h.toLowerCase();
            return lower.includes('date') || lower === 'days';
        }

        // Returns true if the header name is a long-text column
        function isLongTextHeader(h) {
            const lower = h.toLowerCase();
            return lower.includes('remark') || lower.includes('description') || lower.includes('subject');
        }

        // Returns true if the header is an email address column  
        function isEmailHeader(h) {
            const lower = h.toLowerCase();
            return lower.includes('email received from') || lower.includes('sent to') || 
                   lower.includes('fwd by') || lower.includes('sent email');
        }

        // Build a context object: header‚Üívalue for a full row
        function buildRowContext(headers, rowData) {
            const ctx = {};
            headers.forEach((h, i) => { ctx[h.toLowerCase()] = rowData[i] || ''; });
            return ctx;
        }

        // Create a smart <td> based on header name and value.
        // Uses INLINE styles on the wrapper div ‚Äî guaranteed to work regardless of CSS cascade.
        // table-layout:fixed on <table> + inline width on wrapper div = bulletproof truncation.
        function makeSmartCell(header, rawVal, allHeaders, rowData) {
            var td = document.createElement('td');
            var val = (rawVal === null || rawVal === undefined) ? '' : rawVal.toString().trim();

            if (isDateHeader(header) && header.toLowerCase().indexOf('days') === -1) {
                // ‚îÄ‚îÄ DATE ‚îÄ‚îÄ
                td.textContent = formatDateForDisplay(val);
                td.style.whiteSpace = 'nowrap';

            } else if (isLongTextHeader(header)) {
                // ‚îÄ‚îÄ LONG TEXT ‚Äî inline styles guarantee truncation in every browser ‚îÄ‚îÄ
                td.style.cssText = 'max-width:180px;width:180px;overflow:hidden;padding:8px 10px;';

                var wrapper = document.createElement('div');
                wrapper.style.cssText = 'display:flex;align-items:center;gap:5px;width:100%;overflow:hidden;';

                var span = document.createElement('span');
                span.style.cssText = 'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;font-size:0.82rem;';
                span.textContent = val || '\u2014';  // em dash for empty
                span.title = val;
                wrapper.appendChild(span);

                if (val.length > 20) {
                    var btn = document.createElement('button');
                    btn.className = 'remark-expand-btn';
                    btn.textContent = 'View';
                    btn.title = 'View full ' + header;
                    btn.onclick = (function(rv, hd, aH, rD) {
                        return function(e) {
                            e.stopPropagation();
                            var ctx = buildRowContext(aH, rD);
                            var details = [{ label: hd, value: rv }];
                            var contextFields = [
                                'status', 'resolved/pending',
                                'pending action from client',
                                'last follow-up date', 'last follow up date',
                                'resolution date', 'email date', 'call received date'
                            ];
                            contextFields.forEach(function(f) {
                                if (ctx[f] && ctx[f].trim() && ctx[f].trim() !== rv) {
                                    var lbl = aH.find(function(h){ return h.toLowerCase() === f; }) || f;
                                    var v2 = isDateHeader(f) ? formatDateForDisplay(ctx[f]) : ctx[f];
                                    details.push({ label: lbl, value: v2 });
                                }
                            });
                            openRemarkModal(hd, details);
                        };
                    })(val, header, allHeaders, rowData);
                    wrapper.appendChild(btn);
                }

                td.appendChild(wrapper);

            } else if (isEmailHeader(header) && val.indexOf('@') !== -1) {
                // ‚îÄ‚îÄ EMAIL with copy button ‚îÄ‚îÄ
                var ewrap = document.createElement('span');
                ewrap.style.cssText = 'display:inline-flex;align-items:center;gap:3px;';
                var etext = document.createElement('span');
                etext.textContent = val;
                etext.style.fontSize = '0.80rem';
                var copyBtn = document.createElement('button');
                copyBtn.className = 'copy-email-btn';
                copyBtn.innerHTML = '\uD83D\uDCCB';
                copyBtn.title = 'Copy email';
                copyBtn.onclick = (function(v) {
                    return function(e) {
                        e.stopPropagation();
                        navigator.clipboard.writeText(v).then(function(){ showToast('Email copied'); });
                    };
                })(val);
                ewrap.appendChild(etext);
                ewrap.appendChild(copyBtn);
                td.appendChild(ewrap);

            } else {
                // ‚îÄ‚îÄ PLAIN ‚îÄ‚îÄ
                td.textContent = val;
                if (val.length > 15) td.title = val;  // hover tooltip for truncated plain cells
            }
            return td;
        }

        // ========== GENERATE ROWS ==========
        
        function generateEmailRows(dataRows = null) {
            const tbody = document.getElementById('emailTbody');
            tbody.innerHTML = '';
            
            const rows = dataRows ? filterEmptyRows(dataRows) : [
                ['clientA@example.com', 'C001', 'North', 'Issue with login portal ‚Äî client unable to access net banking since last update', 'Kavita', '2026-02-15', 'Rahul', 'support@bank.com', 'sent', 'Pending', '', 'Client', '2026-02-18', '2026-02-16', 'Waiting for client to respond - escalated to tech team for further review and resolution', 'Billing', 'Email'],
                ['clientB@example.com', 'C002', 'South', 'Statement not received', 'Neelam', '2026-02-10', 'Kavita', 'accounts@bank.com', 'sent', 'Resolved', '', 'Done', '2026-02-14', '2026-02-12', 'Closed - Client confirmed receipt of statement on 14th Feb', 'Statements', 'Email'],
                ['clientC@example.com', 'C003', 'East', 'Payment not reflecting in account after 3 business days', 'Rahul', '2026-02-01', 'Neelam', 'payments@bank.com', 'sent', 'In Progress', '', 'Client', '', '2026-02-02', 'Following up with payments department - awaiting clearance from backend team, SLA breach expected', 'Payments', 'Email']
            ];

            // Data headers (emailHeaders without Select, S.No, Actions)
            const dataHeaders = emailHeaders.slice(2, -1);

            rows.forEach((rowData, idx) => {
                const tr = document.createElement('tr');
                tr.id = `email-row-${Date.now()}-${idx}`;
                
                // Checkbox cell
                const selectTd = document.createElement('td');
                selectTd.className = 'checkbox-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'email-row-select';
                checkbox.onchange = updateSelectionCounts;
                selectTd.appendChild(checkbox);
                tr.appendChild(selectTd);
                
                // S.No cell
                const snoTd = document.createElement('td');
                snoTd.textContent = (idx + 1).toString();
                tr.appendChild(snoTd);
                
                // Data cells ‚Äî use header-driven rendering
                for (let i = 0; i < dataHeaders.length; i++) {
                    const header = dataHeaders[i];
                    const val = rowData[i] !== undefined ? rowData[i] : '';
                    tr.appendChild(makeSmartCell(header, val, dataHeaders, rowData));
                }
                
                tr.appendChild(createActionCell('email'));
                tbody.appendChild(tr);
            });
            
            updateAllAging();
            updateSelectionCounts();
        }

        function generateCallRows(dataRows = null) {
            const tbody = document.getElementById('callTbody');
            tbody.innerHTML = '';
            
            const rows = dataRows ? filterEmptyRows(dataRows) : [
                ['C001', 'North', 'Call about missing email - client says statement never arrived', 'Kavita', '2026-02-14', 'client@example.com', 'sent', '2026-02-16', '2', 'Resolved', 'Completed - sent statement copy via email'],
                ['C002', 'South', 'Follow-up on statement', 'Rahul', '2026-02-05', 'clientB@example.com', 'sent', '2026-02-07', '2', 'Resolved', 'Completed'],
                ['C003', 'East', 'Technical support call', 'Neelam', '2026-02-10', 'clientC@example.com', 'sent', '', '5', 'Pending', 'Waiting for callback - client not reachable, tried 3 times over 2 days']
            ];

            const dataHeaders = callHeaders.slice(2, -1);
            
            rows.forEach((rowData, idx) => {
                const tr = document.createElement('tr');
                tr.id = `call-row-${Date.now()}-${idx}`;
                
                const selectTd = document.createElement('td');
                selectTd.className = 'checkbox-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'call-row-select';
                checkbox.onchange = updateSelectionCounts;
                selectTd.appendChild(checkbox);
                tr.appendChild(selectTd);
                
                const snoTd = document.createElement('td');
                snoTd.textContent = (idx + 1).toString();
                tr.appendChild(snoTd);
                
                for (let i = 0; i < dataHeaders.length; i++) {
                    const header = dataHeaders[i];
                    const val = rowData[i] !== undefined ? rowData[i] : '';
                    tr.appendChild(makeSmartCell(header, val, dataHeaders, rowData));
                }
                
                tr.appendChild(createActionCell('call'));
                tbody.appendChild(tr);
            });
            
            updateAllAging();
            updateSelectionCounts();
        }

        // ========== RENDER TABLES ==========
        
        function renderEmailTable() {
            const thead = document.getElementById('emailThead');
            const tr = document.createElement('tr');
            
            emailHeaders.forEach((h, idx) => {
                const th = document.createElement('th');
                th.textContent = h;
                
                if (idx !== 0 && idx !== 1 && idx !== emailHeaders.length-1) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-col-btn';
                    delBtn.innerHTML = '‚úï';
                    delBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (!emailDeleteMode) { alert('Enable delete mode first'); return; }
                        deleteColumn('email', idx);
                    };
                    th.appendChild(delBtn);
                }
                tr.appendChild(th);
            });
            
            thead.innerHTML = '';
            thead.appendChild(tr);
            generateEmailRows();
            makeSortable('emailTable', 'emailThead');
        }

        function renderCallTable() {
            const thead = document.getElementById('callThead');
            const tr = document.createElement('tr');
            
            callHeaders.forEach((h, idx) => {
                const th = document.createElement('th');
                th.textContent = h;
                
                if (idx !== 0 && idx !== 1 && idx !== callHeaders.length-1) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-col-btn';
                    delBtn.innerHTML = '‚úï';
                    delBtn.onclick = function(e) {
                        e.stopPropagation();
                        if (!callDeleteMode) { alert('Enable delete mode first'); return; }
                        deleteColumn('call', idx);
                    };
                    th.appendChild(delBtn);
                }
                tr.appendChild(th);
            });
            
            thead.innerHTML = '';
            thead.appendChild(tr);
            generateCallRows();
            makeSortable('callTable', 'callThead');
        }

        // ========== COLUMN MANAGEMENT ==========
        
        function deleteColumn(tableType, colIndex) {
            if (tableType === 'email') {
                if (colIndex <= 1 || colIndex >= emailHeaders.length-1) return alert("Cannot delete Select, S.No, or Actions");
                emailHeaders.splice(colIndex, 1);
                renderEmailTable();
                emailDeleteMode = false;
                document.getElementById('toggleDeleteEmailBtn').innerHTML = 'üóëÔ∏è Delete mode (off)';
            } else {
                if (colIndex <= 1 || colIndex >= callHeaders.length-1) return alert("Cannot delete Select, S.No, or Actions");
                callHeaders.splice(colIndex, 1);
                renderCallTable();
                callDeleteMode = false;
                document.getElementById('toggleDeleteCallBtn').innerHTML = 'üóëÔ∏è Delete mode (off)';
            }
            showToast('Column deleted');
        }

        function addColumn(tableType) {
            const colName = prompt("Enter new column name:");
            if (!colName) return;
            if (tableType === 'email') {
                emailHeaders.splice(emailHeaders.length-1, 0, colName);
                renderEmailTable();
            } else {
                callHeaders.splice(callHeaders.length-1, 0, colName);
                renderCallTable();
            }
            showToast('Column added');
        }

        // ========== STATS UPDATE ==========
        
        function updateStats() {
            const emailRows = document.getElementById('emailTbody').children.length;
            const callRows = document.getElementById('callTbody').children.length;
            document.getElementById('statEmail').innerText = emailRows;
            document.getElementById('statCall').innerText = callRows;
            
            let emailPending = 0, emailResolved = 0, emailCritical = 0, emailTotalDays = 0, emailCountWithAge = 0;
            document.querySelectorAll('#emailTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const statusCell = cells[11];
                const ageCell = cells[12];
                
                if (statusCell) {
                    const status = statusCell.innerText.toLowerCase();
                    if (status.includes('pending') || status.includes('progress') || status.includes('hold')) {
                        emailPending++;
                    } else if (status.includes('resolved')) {
                        emailResolved++;
                    }
                }
                
                if (ageCell) {
                    const age = parseInt(ageCell.innerText) || 0;
                    if (age > 0) {
                        emailTotalDays += age;
                        emailCountWithAge++;
                    }
                    if (age >= 5) emailCritical++;
                }
            });
            
            let callPending = 0, callResolved = 0, callCritical = 0, callTotalDays = 0, callCountWithAge = 0;
            document.querySelectorAll('#callTbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const statusCell = cells[11];
                const daysCell = cells[10];
                
                if (statusCell) {
                    const status = statusCell.innerText.toLowerCase();
                    if (status.includes('pending') || status.includes('progress')) {
                        callPending++;
                    } else if (status.includes('resolved')) {
                        callResolved++;
                    }
                }
                
                if (daysCell) {
                    const days = parseInt(daysCell.innerText) || 0;
                    if (days > 0) {
                        callTotalDays += days;
                        callCountWithAge++;
                    }
                    if (days >= 5) callCritical++;
                }
            });
            
            document.getElementById('statPending').innerText = emailPending + callPending;
            document.getElementById('statResolved').innerText = emailResolved + callResolved;
            document.getElementById('statCritical').innerText = emailCritical + callCritical;
            
            const totalDays = emailTotalDays + callTotalDays;
            const totalCount = emailCountWithAge + callCountWithAge;
            const avgDays = totalCount > 0 ? (totalDays / totalCount).toFixed(1) : '0';
            document.getElementById('statAvg').innerText = avgDays;
        }

        // ========== SELECTION FUNCTIONS ==========
        
        function updateSelectionCounts() {
            const emailSelected = document.querySelectorAll('.email-row-select:checked').length;
            const callSelected = document.querySelectorAll('.call-row-select:checked').length;
            
            document.getElementById('emailSelectedCount').textContent = `${emailSelected} selected`;
            document.getElementById('callSelectedCount').textContent = `${callSelected} selected`;
        }

        function setupSelectAll() {
            document.getElementById('selectAllEmail').addEventListener('change', function(e) {
                document.querySelectorAll('.email-row-select').forEach(cb => cb.checked = e.target.checked);
                updateSelectionCounts();
            });
            
            document.getElementById('selectAllCall').addEventListener('change', function(e) {
                document.querySelectorAll('.call-row-select').forEach(cb => cb.checked = e.target.checked);
                updateSelectionCounts();
            });
        }

        window.selectAllEmailRows = function() {
            document.querySelectorAll('.email-row-select').forEach(cb => cb.checked = true);
            document.getElementById('selectAllEmail').checked = true;
            updateSelectionCounts();
        };

        window.selectAllCallRows = function() {
            document.querySelectorAll('.call-row-select').forEach(cb => cb.checked = true);
            document.getElementById('selectAllCall').checked = true;
            updateSelectionCounts();
        };

        // ========== EXCEL IMPORT/EXPORT ==========
        
        function downloadExcel(tableType) {
            let headers, tbodyId, filename;
            if (tableType === 'email') {
                headers = emailHeaders.filter(h => h !== 'Select' && h !== 'Actions');
                tbodyId = 'emailTbody';
                filename = 'email_followups.xlsx';
            } else {
                headers = callHeaders.filter(h => h !== 'Select' && h !== 'Actions');
                tbodyId = 'callTbody';
                filename = 'call_followups.xlsx';
            }
            
            const data = [headers];
            const tbody = document.getElementById(tbodyId);
            
            Array.from(tbody.children).forEach(tr => {
                const cells = tr.querySelectorAll('td');
                const rowData = [];
                for (let i = 1; i < cells.length - 1; i++) {
                    rowData.push(cells[i].innerText);
                }
                data.push(rowData);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, filename);
            showToast(`${tableType} data exported`);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                let data = [];
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'csv') {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    data = lines.map(line => 
                        line.split(',').map(s => s.replace(/^"|"$/g, '').replace(/""/g, '"'))
                    );
                } else {
                    const workbook = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    data = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: 'DD/MM/YYYY' });
                }
                
                if (data.length < 1) return;

                // File's own header row ‚Äî used to detect column types dynamically
                const fileHeaders = (data[0] || []).map(h => (h || '').toString().trim());
                
                const dataRows = data.slice(1).filter(row => 
                    row.some(cell => cell && cell.toString().trim() !== '')
                );
                
                const headerCount = fileHeaders.length;
                if (headerCount >= 15) {
                    generateEmailRowsFromFile(dataRows, fileHeaders);
                    showToast('Email data loaded ‚Äî ' + dataRows.length + ' rows');
                } else if (headerCount >= 10) {
                    generateCallRowsFromFile(dataRows, fileHeaders);
                    showToast('Call data loaded ‚Äî ' + dataRows.length + ' rows');
                } else {
                    alert('Could not detect table type. Please ensure file matches email or call structure.');
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
            
            event.target.value = '';
        }

        // Renders uploaded rows using the FILE's own headers for column type detection
        function generateEmailRowsFromFile(dataRows, fileHeaders) {
            const tbody = document.getElementById('emailTbody');
            tbody.innerHTML = '';

            // Detect if the file already has an S.No / serial number column as its first data column
            // so we don't render it twice (we add our own programmatic counter)
            const snoPattern = /^(s\.?\s*no\.?|sr\.?\s*no\.?|serial\s*no\.?|#|sl\.?\s*no\.?)$/i;
            const firstColIsSno = fileHeaders.length > 0 && snoPattern.test(fileHeaders[0].trim());
            // Headers to render = skip the S.No column from the file if present
            const renderHeaders = firstColIsSno ? fileHeaders.slice(1) : fileHeaders;

            filterEmptyRows(dataRows).forEach(function(rowData, idx) {
                const tr = document.createElement('tr');
                tr.id = 'email-row-' + Date.now() + '-' + idx;

                // Checkbox
                const selectTd = document.createElement('td');
                selectTd.className = 'checkbox-cell';
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.className = 'email-row-select';
                cb.onchange = updateSelectionCounts;
                selectTd.appendChild(cb); tr.appendChild(selectTd);

                // S.No ‚Äî always use our own sequential counter
                const snoTd = document.createElement('td');
                snoTd.textContent = idx + 1;
                tr.appendChild(snoTd);

                // Data cells ‚Äî offset rowData by 1 if file had its own S.No column
                const dataOffset = firstColIsSno ? 1 : 0;
                renderHeaders.forEach(function(header, i) {
                    tr.appendChild(makeSmartCell(header, rowData[i + dataOffset], renderHeaders, rowData.slice(dataOffset)));
                });

                tr.appendChild(createActionCell('email'));
                tbody.appendChild(tr);
            });

            updateAllAging(); updateSelectionCounts(); updateStats();
        }

        function generateCallRowsFromFile(dataRows, fileHeaders) {
            const tbody = document.getElementById('callTbody');
            tbody.innerHTML = '';

            const snoPattern = /^(s\.?\s*no\.?|sr\.?\s*no\.?|serial\s*no\.?|#|sl\.?\s*no\.?)$/i;
            const firstColIsSno = fileHeaders.length > 0 && snoPattern.test(fileHeaders[0].trim());
            const renderHeaders = firstColIsSno ? fileHeaders.slice(1) : fileHeaders;

            filterEmptyRows(dataRows).forEach(function(rowData, idx) {
                const tr = document.createElement('tr');
                tr.id = 'call-row-' + Date.now() + '-' + idx;

                const selectTd = document.createElement('td');
                selectTd.className = 'checkbox-cell';
                const cb = document.createElement('input');
                cb.type = 'checkbox'; cb.className = 'call-row-select';
                cb.onchange = updateSelectionCounts;
                selectTd.appendChild(cb); tr.appendChild(selectTd);

                const snoTd = document.createElement('td');
                snoTd.textContent = idx + 1;
                tr.appendChild(snoTd);

                const dataOffset = firstColIsSno ? 1 : 0;
                renderHeaders.forEach(function(header, i) {
                    tr.appendChild(makeSmartCell(header, rowData[i + dataOffset], renderHeaders, rowData.slice(dataOffset)));
                });

                tr.appendChild(createActionCell('call'));
                tbody.appendChild(tr);
            });

            updateAllAging(); updateSelectionCounts(); updateStats();
        }

        // ========== EVENT LISTENERS ==========
        
        document.getElementById('addEmailColBtn').addEventListener('click', ()=> addColumn('email'));
        document.getElementById('addCallColBtn').addEventListener('click', ()=> addColumn('call'));

        document.getElementById('toggleDeleteEmailBtn').addEventListener('click', function() {
            emailDeleteMode = !emailDeleteMode;
            this.innerHTML = emailDeleteMode ? 'üóëÔ∏è Delete mode (ON)' : 'üóëÔ∏è Delete mode (off)';
        });
        
        document.getElementById('toggleDeleteCallBtn').addEventListener('click', function() {
            callDeleteMode = !callDeleteMode;
            this.innerHTML = callDeleteMode ? 'üóëÔ∏è Delete mode (ON)' : 'üóëÔ∏è Delete mode (off)';
        });

        document.getElementById('addEmailRowBtn').addEventListener('click', ()=> openAddModal('email'));
        document.getElementById('addCallRowBtn').addEventListener('click', ()=> openAddModal('call'));

        document.getElementById('deleteEmailMultiBtn').addEventListener('click', ()=> deleteSelectedRows('email'));
        document.getElementById('deleteCallMultiBtn').addEventListener('click', ()=> deleteSelectedRows('call'));

        document.getElementById('downloadEmailBtn').addEventListener('click', ()=> downloadExcel('email'));
        document.getElementById('downloadCallBtn').addEventListener('click', ()=> downloadExcel('call'));

        document.getElementById('uploadBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        document.getElementById('userFileInput').addEventListener('change', handleUserFileUpload);

        // Auto-refresh aging every hour
        setInterval(updateAllAging, 3600000);

        // ========== INITIAL RENDER ==========
        renderTeamAndOnline();
        renderEmailTable();
        renderCallTable();
        setupSelectAll();
        renderUserTable();
        
        // Initialize charts after DOM is ready
        setTimeout(() => {
            initCharts();
        }, 500);
    })();
</script>
</body>
</html>